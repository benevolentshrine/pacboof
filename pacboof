#!/usr/bin/env bash

# pacboof - Simple rofi-based package manager for Arch Linux
# Redesigned for simplicity and ease of use

set -euo pipefail

# ============================================================================
# CONFIGURATION
# ============================================================================

CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/pacboof"
LOG_DIR="${XDG_STATE_HOME:-$HOME/.local/state}/pacboof"
LOG_FILE="$LOG_DIR/pacboof.log"
USER_THEME="$CONFIG_DIR/pacboof.rasi"
SYSTEM_THEME="/usr/share/pacboof/pacboof.rasi"

# Setup logging
mkdir -p "$LOG_DIR"
exec 2> >(tee -a "$LOG_FILE")

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') [INFO] $1" >> "$LOG_FILE"
}

log_error() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') [ERROR] $1" >> "$LOG_FILE"
}

error_handler() {
    local line_no=$1
    local command=$2
    local error_code=$3
    log_error "Error on line $line_no: Command '$command' exited with status $error_code"
    
    if command -v rofi &>/dev/null; then
        # Offer interactive recovery options
        local choice
        choice=$(echo -e "ðŸ“‚ Open Log File\nðŸ“‹ Copy Error to Clipboard\nâŒ Close" | \
            rofi -dmenu \
            -p "âš ï¸ Error detected" \
            -mesg "Command '$command' failed (Line $line_no, Exit $error_code)" \
            -theme-str 'window {width: 600px;}' \
            -theme "$THEME_FILE")
            
        case "$choice" in
            "ðŸ“‚ Open Log File")
                # Try to open with xdg-open, fallback to terminal pager
                if command -v xdg-open &>/dev/null; then
                    xdg-open "$LOG_FILE"
                else
                    detect_terminal | xargs -I {} bash -c "{} less $LOG_FILE" &
                fi
                ;;
            "ðŸ“‹ Copy Error to Clipboard")
                if command -v xclip &>/dev/null; then
                    echo "Command '$command' failed (Line $line_no, Exit $error_code)" | xclip -selection clipboard
                elif command -v wl-copy &>/dev/null; then
                    echo "Command '$command' failed (Line $line_no, Exit $error_code)" | wl-copy
                fi
                ;;
        esac
    fi
}

trap 'error_handler ${LINENO} "$BASH_COMMAND" $?' ERR

# Use user theme if exists, otherwise system theme
if [[ -f "$USER_THEME" ]]; then
    THEME_FILE="$USER_THEME"
elif [[ -f "$SYSTEM_THEME" ]]; then
    THEME_FILE="$SYSTEM_THEME"
else
    THEME_FILE=""
fi

# ============================================================================
# TERMINAL DETECTION
# ============================================================================

detect_terminal() {
    # Try $TERMINAL environment variable first
    if [[ -n "${TERMINAL:-}" ]]; then
        if command -v "$TERMINAL" &>/dev/null; then
            echo "$TERMINAL -e"
            return 0
        fi
    fi
    
    # Auto-detect from common terminals
    # Order: modern GPU-accelerated terminals first, then fallbacks
    local terminals=(
        "kitty:-e"
        "alacritty:-e"
        "wezterm:start --"
        "foot:-e"
        "st:-e"
        "termite:-e"
        "urxvt:-e"
        "xterm:-e"
        "gnome-terminal:--"
        "konsole:-e"
        "xfce4-terminal:-e"
        "mate-terminal:-e"
        "lxterminal:-e"
        "terminator:-e"
        "tilix:-e"
    )

    for term_def in "${terminals[@]}"; do
        local term_name="${term_def%%:*}"
        local term_flags="${term_def#*:}"
        
        if command -v "$term_name" &>/dev/null; then
            echo "$term_name $term_flags"
            return 0
        fi
    done

    # Ultimate fallback - should exist on any system with X
    if command -v xterm &>/dev/null; then
        echo "xterm -e"
        return 0
    fi
    
    # If we're here, something is very wrong
    rofi -e "ERROR: No terminal emulator found!\n\nInstall one of:\nkitty, alacritty, xterm, gnome-terminal, etc."
    return 1
}

# ============================================================================
# CURATED PACKAGE LISTS
# ============================================================================

get_ide_list() {
    cat << 'EOF'
ðŸ’» Visual Studio Code|code
ðŸ PyCharm Community|pycharm-community-edition
â˜• IntelliJ IDEA Community|intellij-idea-community-edition
âœ¨ Neovim|neovim
ðŸ“ Sublime Text|sublime-text-4
EOF
}

get_development_list() {
    cat << 'EOF'
ðŸ Python|python
ðŸ¦€ Rust|rust
ðŸ¹ Go|go
â˜• Java (OpenJDK)|jdk-openjdk
ðŸ“œ JavaScript (Node.js)|nodejs
ðŸ’Ž Ruby|ruby
ðŸ˜ PHP|php
ðŸ”· TypeScript|typescript
ðŸŒ™ Lua|lua
âš¡ Zig|zig
EOF
}

get_tui_list() {
    cat << 'EOF'
ðŸ“Š btop (System Monitor)|btop
ðŸ“ ranger (File Manager)|ranger
ðŸŽµ cmus (Music Player)|cmus
ðŸ“ vim (Text Editor)|vim
âš¡ nvim (Text Editor)|neovim
ðŸ” fzf (Fuzzy Finder)|fzf
ðŸ“¦ yay (AUR Helper)|yay
ðŸŒ w3m (Web Browser)|w3m
ðŸ“§ neomutt (Email)|neomutt
ðŸ’¬ irssi (IRC Client)|irssi
EOF
}

# ============================================================================
# ROFI FUNCTIONS
# ============================================================================

show_main_menu() {
    local theme_arg=""
    if [[ -f "$THEME_FILE" ]]; then
        theme_arg="-theme $THEME_FILE"
    fi
    
    cat << 'EOF' | rofi -dmenu -p "pacboof" $theme_arg -no-custom
ðŸ“¦ Install (Native Packages)
ðŸš€ Install AUR
ðŸ—‘ï¸  Remove Packages
ðŸ’» IDEs
ðŸ”§ Development Languages
âŒ¨ï¸  TUI Apps
EOF
}

show_curated_menu() {
    local prompt="$1"
    local list="$2"
    local theme_arg=""
    
    if [[ -f "$THEME_FILE" ]]; then
        theme_arg="-theme $THEME_FILE"
    fi
    
    echo "$list" | rofi -dmenu -p "$prompt" $theme_arg -format "s"
}

# ============================================================================
# INSTALLATION FUNCTIONS
# ============================================================================

extract_package_name() {
    local selection="$1"
    # Extract package name after the |
    echo "$selection" | cut -d'|' -f2
}

install_package() {
    local package="$1"
    local use_aur="${2:-false}"
    
    log "Starting installation of $package (AUR: $use_aur)"
    
    local terminal_cmd
    terminal_cmd=$(detect_terminal)
    
    if [[ "$use_aur" == "true" ]]; then
        $terminal_cmd bash -c "yay -S $package; echo; read -p 'Press Enter to continue...' -n1 -s"
    else
        $terminal_cmd bash -c "sudo pacman -S $package; echo; read -p 'Press Enter to continue...' -n1 -s"
    fi
}

open_interactive_install() {
    local use_aur="${1:-false}"
    
    # Check for fzf first - it's essential for good UX
    if ! command -v fzf &>/dev/null; then
        rofi -e "fzf is not installed!\n\nInstall it for package browsing:\nsudo pacman -S fzf\n\nThen try again."
        return 1
    fi
    
    local terminal_cmd
    terminal_cmd=$(detect_terminal)
    
    if [[ "$use_aur" == "true" ]]; then
        # Check for yay
        if ! command -v yay &>/dev/null; then
            rofi -e "yay is not installed!\n\nInstall it first:\nsudo pacman -S yay"
            return 1
        fi
        
        # Use yay with fzf for AUR browsing
        $terminal_cmd bash -c "
            echo 'Loading AUR packages...'
            yay -Slq --aur | fzf \
                --multi \
                --cycle \
                --reverse \
                --prompt='Search AUR packages > ' \
                --preview='yay -Si {1} 2>/dev/null' \
                --preview-window=right:60%:wrap \
                --bind='ctrl-d:preview-half-page-down,ctrl-u:preview-half-page-up' \
                --header='  SPACE: select | ENTER: install | ESC: cancel  ' | \
            xargs -ro yay -S
            xargs -ro yay -S
            wait
            echo; read -p 'Press Enter to continue...' -n1 -s
        "
    else
        # Use pacman with fzf for TUI browsing
        $terminal_cmd bash -c "
            pacman -Slq | fzf \
                --multi \
                --cycle \
                --reverse \
                --prompt='Search packages > ' \
                --preview='pacman -Si {1} 2>/dev/null' \
                --preview-window=right:60%:wrap \
                --bind='ctrl-d:preview-half-page-down,ctrl-u:preview-half-page-up' \
                --header='  SPACE: select | ENTER: install | ESC: cancel  ' | \
            xargs -ro sudo pacman -S
            xargs -ro sudo pacman -S
            wait
            echo; read -p 'Press Enter to continue...' -n1 -s
        "
    fi
}

open_remove_packages() {
    # Check for fzf
    if ! command -v fzf &>/dev/null; then
        rofi -e "fzf is not installed!\n\nInstall it first:\nsudo pacman -S fzf"
        return 1
    fi
    
    local terminal_cmd
    terminal_cmd=$(detect_terminal)
    
    $terminal_cmd bash -c "
        pacman -Qq | fzf \
            --multi \
            --cycle \
            --reverse \
            --prompt='Remove packages > ' \
            --preview='pacman -Qi {1} 2>/dev/null' \
            --preview-window=right:60%:wrap \
            --header='  SPACE: select | ENTER: remove | ESC: cancel  ' | \
            --header='  SPACE: select | ENTER: remove | ESC: cancel  ' | \
        xargs -ro sudo pacman -Rns
        xargs -ro sudo pacman -Rns
        wait
        echo; read -p 'Press Enter to continue...' -n1 -s
    "
}

# ============================================================================
# MAIN LOGIC
# ============================================================================

main() {
    # Check dependencies
    if ! command -v rofi &>/dev/null; then
        echo "ERROR: rofi is not installed" >&2
        exit 1
    fi

    # Show main menu loop
    while true; do
        local choice
        choice=$(show_main_menu)

        if [[ -z "$choice" ]]; then
            exit 0
        fi

    case "$choice" in
        "ðŸ“¦ Install (Native Packages)")
            open_interactive_install false
            ;;
        "ðŸš€ Install AUR")
            if ! command -v yay &>/dev/null; then
                rofi -e "yay is not installed. Install it first!"
                exit 1
            fi
            open_interactive_install true
            ;;
        "ðŸ—‘ï¸  Remove Packages")
            open_remove_packages
            ;;
        "ðŸ’» IDEs")
            local ide_list
            ide_list=$(get_ide_list)
            local selected
            selected=$(show_curated_menu "Select IDE" "$ide_list")
            
            if [[ -n "$selected" ]]; then
                local package
                package=$(extract_package_name "$selected")
                install_package "$package" true  # Most IDEs are in AUR
            else
                # If no selection, loop back (do nothing)
                true
            fi
            ;;
        "ðŸ”§ Development Languages")
            local dev_list
            dev_list=$(get_development_list)
            local selected
            selected=$(show_curated_menu "Select Language" "$dev_list")
            
            if [[ -n "$selected" ]]; then
                local package
                package=$(extract_package_name "$selected")
                install_package "$package" false  # Languages are in official repos
            else
                # If no selection, loop back (do nothing)
                true
            fi
            ;;
        "âŒ¨ï¸  TUI Apps")
            # Check for fzf
            if ! command -v fzf &>/dev/null; then
                rofi -e "fzf is not installed!\n\nInstall it first:\nsudo pacman -S fzf"
                exit 1
            fi
            
            local terminal_cmd
            terminal_cmd=$(detect_terminal)
            
            # Search for TUI-related packages and show in fzf
            $terminal_cmd bash -c "
                echo 'Searching for TUI applications...'
                # Search for common TUI-related terms
                pacman -Ssq 'tui|ncurses|terminal|console|cli' | sort -u | fzf \
                    --multi \
                    --cycle \
                    --reverse \
                    --prompt='Search TUI Apps > ' \
                    --preview='pacman -Si {1} 2>/dev/null || yay -Si {1} 2>/dev/null' \
                    --preview-window=right:60%:wrap \
                    --header='  SPACE: select | ENTER: install | ESC: cancel  ' | \
                xargs -I {} bash -c '
                    if pacman -Si {} &>/dev/null; then
                        sudo pacman -S {}
                    else
                        yay -S {}
                    fi
                '
                '
                wait
                echo; read -p 'Press Enter to continue...' -n1 -s
            "
            ;;
    esac
    done
}

main "$@"
